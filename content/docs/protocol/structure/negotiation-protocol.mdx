---
title: Negotiation Protocol
description: Detailed specification of the H.I.V.E. Negotiation Protocol (HNP) for secure contract establishment.
icon: Handshake
---

import { Mermaid } from "components/mdx/mermaid";

The H.I.V.E. Negotiation Protocol (HNP) provides a structured framework for agents to propose, negotiate, and
establish formal contracts. This protocol ensures that all participating agents clearly understand and explicitly
agree to the terms under which tasks will be executed.

## Overview

HNP is a state-based protocol that enables agents to:

1. Propose initial contract terms
2. Counter with modified terms
3. Reach agreement through explicit acceptance
4. Formally reject proposals when terms cannot be agreed upon

This process creates cryptographically signed agreements that serve as verifiable proof of the agreed terms.

## Negotiation States and Transitions

The negotiation process follows a defined state machine:

<Mermaid
  chart={`
stateDiagram-v2
    [*] --> INITIATED: Proposal message

    INITIATED --> COUNTER_PROPOSED: CounterProposal message
    INITIATED --> ACCEPTED: Acceptance message
    INITIATED --> REJECTED: Rejection message
    INITIATED --> EXPIRED: Timeout

    COUNTER_PROPOSED --> COUNTER_PROPOSED: CounterProposal message
    COUNTER_PROPOSED --> ACCEPTED: Acceptance message
    COUNTER_PROPOSED --> REJECTED: Rejection message
    COUNTER_PROPOSED --> EXPIRED: Timeout

    ACCEPTED --> [*]: Success outcome
    REJECTED --> [*]: Failure outcome
    EXPIRED --> [*]: Failure outcome

`}
/>

### State Descriptions

- **INITIATED**: The negotiation has begun with an initial Proposal
- **COUNTER_PROPOSED**: One or more terms have been modified by either party
- **ACCEPTED**: All parties have agreed to the final contract terms
- **REJECTED**: One party has explicitly declined to proceed with the negotiation
- **EXPIRED**: The negotiation timed out without reaching acceptance

## Negotiation Protocol Flow

### 1. Initiation Phase

- **Initiator Role**: The agent that begins the negotiation process by sending a `Proposal` message
- **Responder Role**: The agent that receives and evaluates the proposal

#### Proposal Message

The initiating agent sends a `Proposal` message containing:

- A unique `negotiation_id` (UUID v4)
- A complete draft contract in JSON-LD format following the [H.I.V.E. Contract Ontology](/docs/protocol/structure/contract)
- The message is signed by the initiator's private key

```json
{
  "protocol_version": "1.0.0",
  "message_id": "uuid-v4-message-id",
  "sender_did": "did:key:z6MkpTHR...",
  "recipient_did": "did:key:z6Mkpa4...",
  "timestamp": "2024-07-01T15:30:00Z",
  "message_type": "Proposal",
  "negotiation_id": "uuid-v4-negotiation-id",
  "contract_offer": {
    "@context": "https://hive.protocol/contexts/contract/v1",
    "id": "urn:uuid:f81d4fae-7dec-11d0-a765-00a0c91e6bf6",
    "type": "HIVE_Contract",
    "parties": [
      {
        "did": "did:key:z6MkpTHR...",
        "role": "initiator"
      },
      {
        "did": "did:key:z6Mkpa4...",
        "role": "responder"
      }
    ],
    "contractTerms": {
      // Complete contract terms as per Contract Ontology
    }
  },
  "signature": "base64url-encoded-signature"
}
```

### 2. Evaluation & Response Phase

Upon receiving a `Proposal` or `CounterProposal`, the agent must evaluate the terms and respond with one of:

- **Acceptance**: Agree to the contract as proposed
- **CounterProposal**: Suggest modifications to one or more terms
- **Rejection**: Decline the proposal entirely

#### CounterProposal Message

If the responding agent wishes to modify terms, it sends a `CounterProposal` with:

- The same `negotiation_id` to maintain conversation context
- A modified `contract_offer` reflecting the desired changes
- The agent's signature

```json
{
  "protocol_version": "1.0.0",
  "message_id": "uuid-v4-message-id-2",
  "sender_did": "did:key:z6Mkpa4...",
  "recipient_did": "did:key:z6MkpTHR...",
  "timestamp": "2024-07-01T15:32:00Z",
  "message_type": "CounterProposal",
  "negotiation_id": "uuid-v4-negotiation-id",
  "contract_offer": {
    // Modified contract with changes to specific terms
  },
  "signature": "base64url-encoded-signature"
}
```

- Counter-proposals can be exchanged multiple times as needed
- Each party can propose further modifications until agreement is reached
- Each counter-proposal completely replaces the previous contract offer

### 3. Agreement or Termination Phase

The negotiation concludes with either formal acceptance or rejection.

#### Acceptance Message

When a party accepts the current contract offer, it sends an `Acceptance` message:

```json
{
  "protocol_version": "1.0.0",
  "message_id": "uuid-v4-message-id-3",
  "sender_did": "did:key:z6MkpTHR...",
  "recipient_did": "did:key:z6Mkpa4...",
  "timestamp": "2024-07-01T15:35:00Z",
  "message_type": "Acceptance",
  "negotiation_id": "uuid-v4-negotiation-id",
  "contract_id": "urn:uuid:f81d4fae-7dec-11d0-a765-00a0c91e6bf6",
  "contract_hash": "sha256:9f86d081884c7d659a2feaa0c55ad015a3bf4f1b2b0b822cd15d6c15b0f00a08",
  "signature": "base64url-encoded-signature"
}
```

- The `contract_hash` is the SHA-256 hash of the canonicalized JSON of the last `contract_offer`
- This serves as a safeguard against confusion about which version was accepted
- The agent accepting the contract MUST add their signature to the contract's signatures array before sending the Acceptance

#### Rejection Message

If terms cannot be agreed upon, either party can send a `Rejection` message:

```json
{
  "protocol_version": "1.0.0",
  "message_id": "uuid-v4-message-id-4",
  "sender_did": "did:key:z6Mkpa4...",
  "recipient_did": "did:key:z6MkpTHR...",
  "timestamp": "2024-07-01T15:33:00Z",
  "message_type": "Rejection",
  "negotiation_id": "uuid-v4-negotiation-id",
  "reason": "Proposed payment terms do not meet our minimum requirements",
  "signature": "base64url-encoded-signature"
}
```

- The optional `reason` field provides context for the rejection
- Once rejected, the same `negotiation_id` cannot be reused

## Timeouts and Expiration

To prevent stalled negotiations:

- Negotiations `MUST` have an explicit or implicit timeout period
- The recommended timeout is 5 minutes for standard negotiations
- For complex contracts, longer timeouts (up to 1 hour) may be appropriate
- When a timeout occurs, the negotiation state automatically transitions to `EXPIRED`
- The initiating agent `SHOULD` track the timeout and can formally close the negotiation with an `Error` message
  using the error code `HIVE_IT_010` (NEGOTIATION_TIMEOUT)

## Contract Signature Process

Signatures are critical to ensuring the validity and authenticity of contracts:

1. **Initial Proposal**: The initiator includes their signature in the contract's `signatures` array
2. **Counter-Proposal**: When making changes, the agent replaces any existing signature with their own
3. **Final Acceptance**: The accepting agent adds their signature to the contract before sending the Acceptance message
4. **Verification**: Upon receiving an Acceptance, agents must verify all signatures against the respective DIDs

### Signature Creation

To sign a contract:

1. Extract the `id`, `type`, and `contractTerms` fields
2. Canonicalize this data using JSON Canonicalization Scheme (JCS)
3. Sign the canonicalized data with the agent's private key
4. Encode the signature using base64url format
5. Add a signature entry to the `signatures` array:

```json
{
  "signer": "did:key:z6MkpTHR...",
  "signatureValue": "base64url-encoded-signature",
  "timestamp": "2024-07-01T15:30:00Z"
}
```

## Handling Negotiation Errors

### Validation Errors

Agents MUST validate all incoming negotiation messages. Common validation errors include:

- **Invalid Contract Format**: When a contract doesn't conform to the H.I.V.E. Contract Ontology
- **Missing Required Fields**: When mandatory fields are absent from the contract
- **Schema Validation Failures**: When field values don't match their specified schemas
- **Signature Verification Failures**: When signatures don't match the purported signers

When validation errors occur, agents SHOULD respond with an `Error` message containing the appropriate error code and details.

### Communication Failures

If communication is disrupted during negotiation:

1. Agents SHOULD attempt to re-establish connection and continue the negotiation
2. If reconnection succeeds, the agent SHOULD query the current negotiation state before proceeding
3. If reconnection fails within the timeout period, the negotiation SHOULD be considered EXPIRED

## Multi-Party Negotiations

For contracts involving more than two parties:

1. The initiator includes all parties in the contract's `parties` array
2. The negotiation proceeds in rounds, with each party having an opportunity to counter-propose
3. The contract is considered accepted only when ALL parties have signed it
4. The initiator is responsible for coordinating the multi-party negotiation flow

## Security Considerations

### Replay Protection

To prevent replay attacks:

- Each negotiation message MUST have a unique `message_id`
- Agents MUST track received `message_id` values and reject duplicates
- Messages MUST include timestamps and should be rejected if outside a reasonable time window

### Man-in-the-Middle Protection

- All negotiation messages MUST be sent over the secure, authenticated channel established during the connection phase
- Message signatures provide an additional layer of authenticity verification

### Contract Tampering Protection

- The `contract_hash` in Acceptance messages prevent confusion about which version was accepted
- Signatures bind agents to specific contract terms
- The use of DIDs with cryptographic verification prevents identity spoofing

## Best Practices

### Efficient Negotiation

1. **Clear Initial Proposals**: Initiators should send well-formed proposals that anticipate the responder's requirements
2. **Targeted Counter-Proposals**: Only modify the specific terms that need adjustment, not the entire contract
3. **Progressive Refinement**: Move toward agreement by addressing the most critical differences first
4. **Explanation of Changes**: Include context for why specific changes are requested

### Negotiation Privacy

1. **Sensitive Terms**: Consider whether certain terms should be encrypted within the contract
2. **Negotiation Record**: Decide whether to retain the negotiation history for audit purposes
3. **Private Channels**: For highly sensitive negotiations, consider using private communication channels

### Automated Negotiation

1. **Policy-Based Acceptance**: Define clear acceptance criteria for automated contract approval
2. **Bounded Counter-Proposals**: Establish limits on automatic modifications to contract terms
3. **Human Escalation**: Include mechanisms to escalate complex negotiations to human operators

## Implementation Considerations

### State Management

1. **Persistent Storage**: Store negotiation state in durable storage to recover from crashes
2. **Transaction Log**: Maintain a log of all negotiation messages for audit and recovery
3. **Concurrent Negotiations**: Support multiple parallel negotiations with different parties

### User Interface Considerations

1. **Progress Indication**: Show the current stage in the negotiation process
2. **Term Comparison**: Visually highlight differences between proposals and counter-proposals
3. **Summary View**: Provide a concise summary of the most important contract terms

## Summary

The H.I.V.E. Negotiation Protocol provides a structured, secure mechanism for establishing formal agreements
between agents. By following this protocol, agents can:

- Clearly communicate their requirements and constraints
- Systematically work toward mutually acceptable terms
- Create cryptographically verifiable contracts
- Handle negotiation failures gracefully

This foundation of clear agreements enables the reliable execution of tasks within the H.I.V.E. ecosystem.

---

_This specification is subject to enhancement proposals through the H.I.V.E. Protocol Improvement Process._
