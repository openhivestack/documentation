---
title: Discovery Flow
description: Comprehensive specification of agent discovery patterns and processes within H.I.V.E.
icon: Search
---

import { Mermaid } from "components/mdx/mermaid";
import { Callout } from "fumadocs-ui/components/callout";

Agent discovery is a fundamental capability of the H.I.V.E. Protocol, enabling agents to find and connect with
other agents that provide desired capabilities. This document details the complete discovery flow, from initial
bootstrap to capability matching and connection establishment.

## Discovery Patterns

H.I.V.E. supports multiple discovery patterns to accommodate different network topologies and trust models:

### 1. Centralized Discovery (Required)

- Uses a **Discovery Registry (DR) Service** as a central lookup mechanism
- All agents `MUST` support this pattern for baseline interoperability
- Provides a reliable, efficient starting point for capability discovery

### 2. Peer-to-Peer Discovery (Optional)

- Direct agent-to-agent discovery without central coordination
- Uses techniques like multicast, DHT (Distributed Hash Table), or known rendezvous points
- Enhances resilience in case central registry is unavailable

### 3. Federated Discovery (Optional)

- Multiple interconnected Discovery Registries sharing agent information
- Enables discovery across organizational boundaries while maintaining some local control
- Registry-to-registry communication follows standardized protocols

## Discovery Registry Service

### Core Functionality

The Discovery Registry Service provides three essential functions:

1. **Registration**: Allows agents to advertise their capabilities
2. **Lookup**: Enables searching for agents by capability or identity
3. **Health Monitoring**: Tracks agent availability and responsiveness

### API Specification

The DR Service exposes a RESTful API with the following endpoints:

#### Agent Registration

```
POST /agents
Content-Type: application/json

{
  "capability_advertisement": {
    // Complete CapabilityAdvertisement message
  }
}
```

Response:

```
200 OK
Content-Type: application/json

{
  "registration_id": "uuid-v4",
  "timestamp": "2024-07-01T12:00:00Z",
  "expiration": "2024-07-02T12:00:00Z"
}
```

- Registrations have a default TTL of 24 hours
- Agents `MUST` refresh their registration before expiration
- The DR Service `MAY` perform validation of the capability advertisement

#### Agent Lookup

```
GET /agents?capability=resizeImage&service_type=ImageProcessing
Accept: application/json
```

Response:

```
200 OK
Content-Type: application/json

{
  "results": [
    {
      "agent_did": "did:key:z6MkpTHR...",
      "network_address": "wss://agent.example.com/hive",
      "last_seen": "2024-07-01T11:55:00Z",
      "capability_advertisement": {
        // Full CapabilityAdvertisement message
      }
    },
    // Additional matching agents
  ],
  "total_count": 3,
  "timestamp": "2024-07-01T12:01:00Z"
}
```

Lookup supports various query parameters:
- `capability`: Specific capability intent (e.g., "resizeImage")
- `service_type`: Category of service (e.g., "ImageProcessing")
- `agent_did`: Exact DID to lookup
- `input_schema`: JSON Schema properties required in input
- `output_schema`: JSON Schema properties required in output

#### Health Check

```
GET /agents/{agent_did}/health
Accept: application/json
```

Response:

```
200 OK
Content-Type: application/json

{
  "agent_did": "did:key:z6MkpTHR...",
  "status": "active",
  "last_seen": "2024-07-01T11:55:00Z",
  "response_time_ms": 120,
  "uptime_percentage": 99.8
}
```

- The DR Service `SHOULD` periodically ping registered agents
- Agents that fail to respond to health checks `MAY` be marked as inactive

### Security Considerations

- The DR Service `MUST` validate the signatures on all capability advertisements
- Access control `SHOULD` be implemented to prevent unauthorized registration or de-registration
- Rate limiting `SHOULD` be applied to prevent DoS attacks

## Complete Discovery Flow

The following sequence diagram illustrates the complete agent discovery and connection process:

<Mermaid
  chart={`
sequenceDiagram
    participant A as Agent A (Initiator)
    participant DR as Discovery Registry
    participant B as Agent B (Provider)

    B->>DR: Register capabilities (CapabilityAdvertisement)
    DR-->>B: Confirmation with registration_id

    Note over A,B: Some time later...

    A->>DR: Lookup agents with specific capability
    DR-->>A: List of matching agents with network addresses

    A->>A: Evaluate and select appropriate agent

    A->>B: Establish WebSocket connection
    B-->>A: WebSocket connection accepted

    A->>B: Initiate Noise Protocol handshake
    Note over A,B: Mutual authentication via DIDs
    B-->>A: Complete Noise handshake

    A->>B: Begin Contract Negotiation (Proposal)
`}
/>

## Discovery Bootstrap Process

### Initial DR Service Discovery

To bootstrap the discovery process, agents need to locate a Discovery Registry Service. This can happen through:

1. **Configuration**: Agents are configured with known DR Service URLs
2. **DNS-Based Discovery**: Using DNS SRV records to locate DR Services
3. **Well-Known URI**: Standard locations like `/.well-known/hive-discovery`
4. **Multicast Discovery**: For local network scenarios

<Callout type="info">
  At least one bootstrap method must be implemented to join the H.I.V.E. ecosystem.
  Configuration with fallback to alternative methods is recommended for reliability.
</Callout>

### Example: DNS-Based DR Discovery

Agents can discover DR Services through DNS SRV records:

```
_hive-discovery._wss.example.com. 86400 IN SRV 10 10 443 discovery.example.com.
```

This indicates a H.I.V.E. Discovery Registry Service is available at `wss://discovery.example.com:443/`.

## Capability Advertisement and Matching

### Advertisement Structure

Capability advertisements use the HSDL format to describe an agent's abilities. The critical elements for discovery matching are:

1. **Capabilities Array**: Lists each distinct function the agent can perform
2. **Intent Identifiers**: Standardized names for specific capabilities
3. **Input/Output Schemas**: Define data formats for interoperability

### Matching Algorithms

When searching for agents, the DR Service employs matching algorithms to find appropriate providers:

1. **Exact Intent Matching**: Finding agents that explicitly list a required intent
2. **Schema Compatibility**: Ensuring input/output schemas are compatible
3. **Constraint Satisfaction**: Checking that specific requirements (e.g., response time) can be met
4. **Ranking**: Ordering results by relevance, performance metrics, or other criteria

### Example: Capability Matching

Agent A needs image processing with these requirements:
- Intent: "resizeImage"
- Input: Must accept PNG format
- Output: Must return JPG format
- Constraint: Max processing time < 500ms

The DR Service would match against registered agents' capabilities to find those satisfying these requirements.

## Peer-to-Peer Discovery

For P2P discovery, H.I.V.E. recommends these approaches:

### Local Network Discovery

- **Multicast DNS (mDNS)**: For local network service advertisement
- **DNS-SD**: Service discovery over DNS
- **Simple Service Discovery Protocol (SSDP)**: UPnP-based discovery

### Internet-Scale P2P Discovery

- **Distributed Hash Tables (DHT)**: Kademlia-based approaches
- **Rendezvous Points**: Known meeting locations for initial discovery
- **Gossip Protocols**: Information spreading through the network

## Federated Discovery

In federated setups, Discovery Registries can share information through:

1. **Registry Federation Protocol**: Standard for registry-to-registry communication
2. **Cross-Registry Search**: Propagating queries across registry boundaries
3. **Cache Synchronization**: Periodic syncing of registry data

## Advanced Discovery Topics

### Discovery Caching

To optimize performance:
- Agents `SHOULD` cache discovery results
- Cache entries `SHOULD` have appropriate TTL values
- Cached entries `SHOULD` be refreshed asynchronously

### Progressive Discovery

For complex requirements:
- Start with broad discovery criteria
- Progressively refine based on additional requirements
- Use multi-phase discovery for complex workflows

### Predictive Discovery

For optimized performance:
- Pre-discover agents likely to be needed
- Maintain connections to frequently used agents
- Use historical patterns to predict future needs

## Discovery Lifecycle Management

### Agent Registration Lifecycle

1. **Initial Registration**: Agent registers with DR Service
2. **Periodic Refresh**: Agent updates its registration before expiration
3. **Capability Updates**: Agent modifies its capabilities as they change
4. **Deregistration**: Agent explicitly removes itself when shutting down
5. **Expiration**: Registry automatically removes stale registrations

### Error Handling

Agents must gracefully handle these discovery scenarios:

1. **Registry Unavailable**: Fall back to alternative discovery methods
2. **No Matching Agents**: Report appropriate error or try alternative capabilities
3. **Agent Unreachable**: Try alternative agents or report service unavailability
4. **Authentication Failure**: Handle DID resolution or verification failures

## Implementation Considerations

### Scalability

For high-scale environments:
- Implement efficient indexing of capabilities
- Consider sharding registries by capability domains
- Use caching at multiple levels
- Implement load balancing across registry instances

### Security

To protect the discovery ecosystem:
- Verify all capability advertisement signatures
- Implement reputation systems to rank trustworthy agents
- Protect against malicious advertisements
- Consider privacy implications of capability disclosure

### Performance Monitoring

To maintain quality service:
- Track discovery latency metrics
- Monitor registry availability and response times
- Log failed lookups and registration attempts
- Implement alerting for registry performance degradation

## Summary

The H.I.V.E. Agent Discovery Flow provides a comprehensive framework for agents to advertise their capabilities and discover appropriate partners for collaboration. By supporting multiple discovery patterns and providing detailed registry specifications, H.I.V.E. ensures robust, scalable agent discovery across diverse deployment scenarios.

---

*This specification is subject to enhancement proposals through the H.I.V.E. Protocol Improvement Process.*
